#!/bin/bash
#
# aesdsocket start-stop script
# Uses start-stop-daemon to manage the aesdsocket daemon

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DAEMON="${SCRIPT_DIR}/aesdsocket"
DAEMON_NAME="aesdsocket"
PIDFILE="/var/run/${DAEMON_NAME}.pid"

# Check if the daemon executable exists
if [ ! -x "$DAEMON" ]; then
    echo "Error: $DAEMON not found or not executable"
    exit 1
fi

case "$1" in
    start)
        echo "Starting $DAEMON_NAME..."
        start-stop-daemon --start --quiet --pidfile "$PIDFILE" \
            --make-pidfile --background \
            --exec "$DAEMON" -- -d
        if [ $? -eq 0 ]; then
            echo "$DAEMON_NAME started"
        else
            echo "Failed to start $DAEMON_NAME"
            exit 1
        fi
        ;;
    stop)
        echo "Stopping $DAEMON_NAME..."
        start-stop-daemon --stop --quiet --pidfile "$PIDFILE" \
            --signal TERM --retry=TERM/30/KILL/5
        if [ $? -eq 0 ]; then
            rm -f "$PIDFILE"
            echo "$DAEMON_NAME stopped"
        else
            echo "Failed to stop $DAEMON_NAME (may not be running)"
            exit 1
        fi
        ;;
    restart)
        $0 stop
        sleep 1
        $0 start
        ;;
    status)
        if [ -f "$PIDFILE" ]; then
            PID=$(cat "$PIDFILE")
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "$DAEMON_NAME is running (PID: $PID)"
                exit 0
            else
                echo "$DAEMON_NAME is not running (stale PID file)"
                rm -f "$PIDFILE"
                exit 1
            fi
        else
            echo "$DAEMON_NAME is not running"
            exit 1
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0

